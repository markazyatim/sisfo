<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Markaz Qurani</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --sidebar-bg: #1a2c3d; 
            --sidebar-active: #0099ff; 
            --content-bg: #f4f7f9;
        }
        body { background-color: var(--content-bg); font-family: 'Segoe UI', sans-serif; }
        .wrapper { display: flex; align-items: stretch; min-height: 100vh; }
        #sidebar {
            min-width: 260px; max-width: 260px;
            background: var(--sidebar-bg); color: #fff;
            position: fixed; height: 100%; transition: 0.3s; z-index: 100;
        }
        .sidebar-header { padding: 30px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #sidebar ul li a {
            padding: 12px 15px; display: block; color: rgba(255,255,255,0.7);
            text-decoration: none; border-radius: 8px; font-weight: 500; margin: 5px 15px;
        }
        #sidebar ul li a.active { background: var(--sidebar-active); color: white; }
        #content { width: 100%; padding: 30px; margin-left: 260px; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .clickable-name { color: var(--sidebar-active); font-weight: bold; cursor: pointer; text-decoration: underline; }
        
        #loading { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;
        }
        .detail-row { display: flex; padding: 8px 0; border-bottom: 1px solid #eee; }
        .detail-label { width: 40%; font-weight: bold; color: #555; }
        
        /* Form Refactoring */
        .form-section-title { 
            font-size: 0.85rem; font-weight: 800; color: #444; 
            background: #f1f3f5; padding: 8px 12px; border-radius: 4px; 
            margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;
        }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <span class="mt-2 fw-bold">Sinkronisasi Data...</span>
</div>

<div class="wrapper">
    <nav id="sidebar">
        <div class="sidebar-header">
            <h5>YAYASAN MARKAZ<br>YATIM DUAFA QURANI</h5>
        </div>
        <ul class="list-unstyled mt-3 nav nav-pills flex-column">
            <li><a href="#tab-santri" class="nav-link active" data-bs-toggle="tab"><i class="fas fa-user-graduate me-2"></i> Santri</a></li>
            <li><a href="#tab-pegawai" class="nav-link" data-bs-toggle="tab"><i class="fas fa-user-tie me-2"></i> Pegawai</a></li>
            <li><a href="#tab-jadwal" class="nav-link" data-bs-toggle="tab"><i class="fas fa-calendar-alt me-2"></i> Jadwal</a></li>
        </ul>
    </nav>

    <div id="content">
        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-santri">
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold m-0">Data Santri</h5>
                        <button class="btn btn-primary btn-sm" onclick="openModal('Santri')"><i class="fa fa-plus me-2"></i>Tambah Santri</button>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-white"><i class="fa fa-search"></i></span>
                        <input type="text" id="cariSantri" class="form-control" placeholder="Cari Santri..." onkeyup="filterTabel('Santri', 'cariSantri')">
                    </div>
                    <div id="out-Santri"></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-pegawai">
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold m-0">Data Pegawai</h5>
                        <button class="btn btn-primary btn-sm" onclick="openModal('Pegawai')"><i class="fa fa-plus me-2"></i>Tambah Pegawai</button>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-white"><i class="fa fa-search"></i></span>
                        <input type="text" id="cariPegawai" class="form-control" placeholder="Cari Pegawai..." onkeyup="filterTabel('Pegawai', 'cariPegawai')">
                    </div>
                    <div id="out-Pegawai"></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-jadwal">
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold m-0">Jadwal Pelajaran</h5>
                        <button class="btn btn-primary btn-sm" onclick="openModal('Jadwal')"><i class="fa fa-plus me-2"></i>Tambah Jadwal</button>
                    </div>
                    <div id="out-Jadwal"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mainModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <div class="modal-content">
            <form id="mainForm">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="modalTitle">Form Data</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody"></div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary px-5">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Detail Lengkap</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZxTcnPSFAQKmVAUtsAd1rCOO9lh3FER79nnCFPo2Q1bMnnIWdxb5K7_V6-jFzzxaF/exec";

    function toggleLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }

    function loadData(type) {
        toggleLoading(true);
        const container = document.getElementById('out-' + type);
        container.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>`;

        fetch(`${SCRIPT_URL}?targetSheet=${type}`)
        .then(r => r.json())
        .then(res => {
            if (res.rows.length === 0) {
                container.innerHTML = "<div class='alert alert-info'>Data tidak ditemukan.</div>";
                toggleLoading(false);
                return;
            }
            let html = `<div class="table-responsive"><table class="table table-hover table-bordered table-sm align-middle bg-white small">`;
            html += `<thead class="table-dark"><tr>`;
            res.header.forEach(h => html += `<th>${h}</th>`);
            html += `<th class="text-center">AKSI</th></tr></thead><tbody>`;
            res.rows.forEach((row, idx) => {
                let actualIndex = idx + 2; 
                html += `<tr>`;
                row.forEach((cell, cellIdx) => {
                    if(cellIdx === 1) {
                        html += `<td><span class="clickable-name" onclick='viewDetail(${JSON.stringify(res.header)}, ${JSON.stringify(row)})'>${cell || '-'}</span></td>`;
                    } else {
                        html += `<td>${cell || '-'}</td>`;
                    }
                });
                html += `<td class="text-center text-nowrap">
                            <button class="btn btn-sm btn-warning text-white" onclick='handleEdit("${type}", ${JSON.stringify(row)}, ${actualIndex})'><i class="fa fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRow('${type}', ${actualIndex})"><i class="fa fa-trash"></i></button>
                        </td></tr>`;
            });
            container.innerHTML = html + `</tbody></table></div>`;
            toggleLoading(false);
        }).catch(err => { 
            container.innerHTML = "Gagal memuat data."; 
            toggleLoading(false); 
        });
    }

    function viewDetail(headers, row) {
        let body = "";
        headers.forEach((h, i) => {
            body += `<div class="detail-row"><div class="detail-label">${h}</div><div class="detail-value">${row[i] || '-'}</div></div>`;
        });
        document.getElementById('detailBody').innerHTML = body;
        new bootstrap.Modal(document.getElementById('detailModal')).show();
    }

    function openModal(type, rowData = null, rowIndex = "") {
        document.getElementById('modalTitle').innerText = (rowData ? "EDIT " : "TAMBAH ") + type.toUpperCase();
        let body = `<input type="hidden" name="targetSheet" value="${type}"><input type="hidden" name="rowIndex" value="${rowIndex}">`;

        if (type === 'Santri') {
            body += `
            <div class="row">
                <div class="col-md-6 border-end">
                    <div class="form-section-title"><i class="fas fa-id-card me-2"></i>Data Pribadi Santri</div>
                    <div class="row g-2">
                        <div class="col-12"><label class="small fw-bold">Nama Lengkap</label><input type="text" name="nama" class="form-control form-control-sm" required value="${rowData?.[1]||''}"></div>
                        <div class="col-md-6"><label class="small fw-bold">Tempat Lahir</label><input type="text" name="tempat_lahir" class="form-control form-control-sm" value="${rowData?.[8]||''}"></div>
                        <div class="col-md-6"><label class="small fw-bold">Tgl Lahir</label><input type="date" name="tgl_lahir" class="form-control form-control-sm" value="${rowData?.[2]||''}"></div>
                        <div class="col-md-6"><label class="small fw-bold">Jenis Kelamin</label>
                            <select name="gender" class="form-select form-select-sm">
                                <option value="Laki-laki" ${rowData?.[9] === 'Laki-laki' ? 'selected' : ''}>Laki-laki</option>
                                <option value="Perempuan" ${rowData?.[9] === 'Perempuan' ? 'selected' : ''}>Perempuan</option>
                            </select>
                        </div>
                        <div class="col-md-6"><label class="small fw-bold">Jabatan</label><input type="text" name="jabatan" class="form-control form-control-sm" value="${rowData?.[4]||''}"></div>
                        <div class="col-12"><label class="small fw-bold">Musyrif Pembimbing</label><input type="text" name="musyrif" class="form-control form-control-sm" value="${rowData?.[5]||''}"></div>
                        <div class="col-md-6"><label class="small fw-bold">NIK (No. KTP)</label><input type="number" name="nik" class="form-control form-control-sm" value="${rowData?.[6]||''}"></div>
                        <div class="col-md-6"><label class="small fw-bold">No. KK</label><input type="number" name="no_kk" class="form-control form-control-sm" value="${rowData?.[7]||''}"></div>
                        <div class="col-12"><label class="small fw-bold">Alamat</label><textarea name="alamat" class="form-control form-control-sm" rows="2">${rowData?.[3]||''}</textarea></div>
                    </div>
                </div>
                <div class="col-md-6 ps-md-4">
                    <div class="form-section-title"><i class="fas fa-users me-2"></i>Data Orang Tua & Administrasi</div>
                    <div class="row g-2">
                        <div class="col-12"><label class="small fw-bold">Nama Ayah</label><input type="text" name="ayah" class="form-control form-control-sm" value="${rowData?.[10]||''}"></div>
                        <div class="col-12"><label class="small fw-bold">Nama Ibu</label><input type="text" name="ibu" class="form-control form-control-sm" value="${rowData?.[11]||''}"></div>
                        <div class="col-md-6"><label class="small fw-bold">Tanggal Masuk</label><input type="date" name="tgl_masuk" class="form-control form-control-sm" value="${rowData?.[15]||''}"></div>
                        <div class="col-md-6"><label class="small fw-bold">Anak Ke-</label><input type="number" name="anak_ke" class="form-control form-control-sm" value="${rowData?.[12]||''}"></div>
                        <div class="col-md-6"><label class="small fw-bold">Jumlah Saudara</label><input type="number" name="jml_saudara" class="form-control form-control-sm" value="${rowData?.[13]||''}"></div>
                        <div class="col-md-6"><label class="small fw-bold">Status Santri</label>
                            <select name="status" class="form-select form-select-sm">
                                <option value="Umum" ${rowData?.[18] === 'Umum' ? 'selected' : ''}>Umum</option>
                                <option value="Yatim" ${rowData?.[18] === 'Yatim' ? 'selected' : ''}>Yatim</option>
                                <option value="Piatu" ${rowData?.[18] === 'Piatu' ? 'selected' : ''}>Piatu</option>
                                <option value="Duafa" ${rowData?.[18] === 'Duafa' ? 'selected' : ''}>Duafa</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>`;
        } else if (type === 'Pegawai') {
            body += `
            <div class="row g-3">
                <div class="col-12"><label class="small fw-bold">Nama Pegawai</label><input type="text" name="nama" class="form-control" required value="${rowData?.[1]||''}"></div>
                <div class="col-md-6"><label class="small fw-bold">Tanggal Lahir</label><input type="date" name="tgl_lahir" class="form-control" value="${rowData?.[2]||''}"></div>
                <div class="col-md-6"><label class="small fw-bold">Jenis Kelamin</label>
                    <select name="jenis_kelamin" class="form-select">
                        <option value="Laki-laki" ${rowData?.[6] === 'Laki-laki' ? 'selected' : ''}>Laki-laki</option>
                        <option value="Perempuan" ${rowData?.[6] === 'Perempuan' ? 'selected' : ''}>Perempuan</option>
                    </select>
                </div>
                <div class="col-12"><label class="small fw-bold">Alamat</label><textarea name="alamat" class="form-control">${rowData?.[3]||''}</textarea></div>
                <div class="col-md-6"><label class="small fw-bold">Jabatan</label><input type="text" name="jabatan" class="form-control" value="${rowData?.[4]||''}"></div>
                <div class="col-md-6"><label class="small fw-bold">No HP / WA</label><input type="number" name="no_hp" class="form-control" value="${rowData?.[5]||''}"></div>
            </div>`;
        } else if (type === 'Jadwal') {
            body += `
            <div class="row g-3">
                <div class="col-md-6"><label class="small fw-bold">Hari</label>
                    <select name="hari" class="form-select">
                        <option value="Senin" ${rowData?.[1] === 'Senin' ? 'selected' : ''}>Senin</option>
                        <option value="Selasa" ${rowData?.[1] === 'Selasa' ? 'selected' : ''}>Selasa</option>
                        <option value="Rabu" ${rowData?.[1] === 'Rabu' ? 'selected' : ''}>Rabu</option>
                        <option value="Kamis" ${rowData?.[1] === 'Kamis' ? 'selected' : ''}>Kamis</option>
                        <option value="Jumat" ${rowData?.[1] === 'Jumat' ? 'selected' : ''}>Jumat</option>
                        <option value="Sabtu" ${rowData?.[1] === 'Sabtu' ? 'selected' : ''}>Sabtu</option>
                        <option value="Minggu" ${rowData?.[1] === 'Minggu' ? 'selected' : ''}>Minggu</option>
                    </select>
                </div>
                <div class="col-md-6"><label class="small fw-bold">Waktu (Jam)</label><input type="text" name="waktu" class="form-control" placeholder="Contoh: 08:00 - 10:00" value="${rowData?.[2]||''}"></div>
                <div class="col-12"><label class="small fw-bold">Kegiatan / Mapel</label><input type="text" name="mapel" class="form-control" value="${rowData?.[3]||''}"></div>
                <div class="col-12"><label class="small fw-bold">Pengampu / Ustaz</label><input type="text" name="pengajar" class="form-control" value="${rowData?.[4]||''}"></div>
            </div>`;
        }

        document.getElementById('modalBody').innerHTML = body;
        new bootstrap.Modal(document.getElementById('mainModal')).show();
    }

    document.getElementById('mainForm').onsubmit = function(e) {
        e.preventDefault();
        toggleLoading(true);
        fetch(SCRIPT_URL, { method: 'POST', body: new URLSearchParams(new FormData(this))})
        .then(r => r.text()).then(res => { 
            alert(res); 
            loadData(new FormData(this).get('targetSheet')); 
            bootstrap.Modal.getInstance(document.getElementById('mainModal')).hide(); 
        })
        .catch(err => alert("Terjadi kesalahan: " + err))
        .finally(() => toggleLoading(false));
    };

    function handleEdit(t, d, i) { openModal(t, d, i); }
    function deleteRow(t, i) { if(confirm("Hapus data permanen?")) { toggleLoading(true); fetch(`${SCRIPT_URL}?action=delete&targetSheet=${t}&rowIndex=${i}`, {method: 'POST'}).then(() => loadData(t)); } }

    function filterTabel(type, inputId) {
        let filter = document.getElementById(inputId).value.toUpperCase();
        let tr = document.getElementById('out-' + type).getElementsByTagName("tr");
        for (let i = 1; i < tr.length; i++) {
            tr[i].style.display = tr[i].innerText.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }

    document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (e) => {
            const type = e.target.getAttribute("href").replace("#tab-", "").replace(/^\w/, c => c.toUpperCase());
            loadData(type);
        });
    });

    window.onload = () => loadData('Santri');
</script>
</body>
</html>
