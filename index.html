<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Markaz MYDQ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --sidebar-width: 260px; 
            --primary-bg: #1e293b; 
            --active-color: #3b82f6; 
            --body-bg: #f3f4f6;
            --text-color: #334155;
        }
        
        body { font-family: 'Poppins', sans-serif; background-color: var(--body-bg); color: var(--text-color); overflow-x: hidden; }
        
        /* Sidebar */
        #sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); color: #fff; transition: all 0.3s; z-index: 1000; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        #sidebar .brand { padding: 25px 20px; font-size: 1.3rem; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; }
        #sidebar .nav-link { color: #94a3b8; padding: 14px 25px; margin: 8px 15px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        #sidebar .nav-link:hover, #sidebar .nav-link.active { background-color: var(--active-color); color: #fff; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        
        /* Content & Cards */
        #content { margin-left: var(--sidebar-width); padding: 30px; width: calc(100% - var(--sidebar-width)); min-height: 100vh; transition: 0.3s; }
        .page-section { display: none; animation: slideUp 0.5s ease; }
        .page-section.active { display: block; }
        .card { border: none; border-radius: 16px; background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.03); overflow: hidden; margin-bottom: 20px; }
        
        /* Tables */
        .table thead th { background-color: #f8fafc; border-bottom: 2px solid #e2e8f0; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; padding: 15px; }
        .table tbody td { padding: 15px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        
        /* Modal & Forms */
        .modal-content { border-radius: 16px; border: none; }
        .form-control, .form-select { border-radius: 8px; padding: 10px; border: 1px solid #e2e8f0; }
        .form-control:focus { border-color: var(--active-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        @media (max-width: 768px) {
            #sidebar { margin-left: calc(-1 * var(--sidebar-width)); }
            #sidebar.active { margin-left: 0; }
            #content { margin-left: 0; width: 100%; padding: 20px; }
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <nav id="sidebar">
        <div class="brand"><i class="fas fa-mosque me-3 text-info"></i><span>Markaz Admin</span></div>
        <ul class="nav flex-column mt-4">
            <li class="nav-item"><a class="nav-link active" onclick="showPage('santri')"><i class="fas fa-user-graduate me-3"></i>Data Santri</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showPage('pegawai')"><i class="fas fa-chalkboard-teacher me-3"></i>Data Pegawai</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showPage('jadwal')"><i class="fas fa-calendar-alt me-3"></i>Jadwal</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showPage('modul')"><i class="fas fa-book-open me-3"></i>Modul</a></li>
        </ul>
    </nav>

    <div id="content">
        <button class="btn btn-light shadow-sm d-md-none mb-4" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>

        <div id="santri" class="page-section active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark">Data Santri</h3>
                <button class="btn btn-primary" onclick="openModal('Santri')"><i class="fas fa-plus me-2"></i>Tambah Santri</button>
            </div>
            <div class="card">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead><tr><th>Nama & NIK</th><th>Alamat</th><th>Musyrif</th><th>Status</th><th class="text-end">Detail</th></tr></thead>
                        <tbody id="bodySantri"><tr><td colspan="5" class="text-center p-5">Memuat data...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="pegawai" class="page-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark">Data Pegawai</h3>
                <button class="btn btn-primary" onclick="openModal('Pegawai')"><i class="fas fa-plus me-2"></i>Tambah Pegawai</button>
            </div>
            <div class="card">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead><tr><th>Nama</th><th>Jabatan</th><th>No HP</th><th>Alamat</th></tr></thead>
                        <tbody id="bodyPegawai"><tr><td colspan="4" class="text-center p-5">Memuat data...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="jadwal" class="page-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark">Jadwal Kegiatan</h3>
                <button class="btn btn-success text-white" onclick="openModal('Jadwal')"><i class="fas fa-plus me-2"></i>Buat Jadwal</button>
            </div>
            <div class="card">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead><tr><th>Hari</th><th>Waktu</th><th>Materi</th><th>Guru</th></tr></thead>
                        <tbody id="bodyJadwal"><tr><td colspan="4" class="text-center p-5">Memuat data...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="modul" class="page-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark">Modul & Materi</h3>
                <button class="btn btn-info text-white" onclick="openModal('Modul')"><i class="fas fa-upload me-2"></i>Upload Modul</button>
            </div>
            <div class="row g-3" id="containerModul"></div>
        </div>
    </div>

    <div class="modal fade" id="modalForm" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Tambah Data</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="mainForm">
                        <input type="hidden" id="kategoriInput" name="kategori">
                        <div id="formContainer"></div> <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit">
                                <i class="fas fa-save me-2"></i>Simpan Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetailSantri" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold"><i class="fas fa-id-card me-2"></i>Biodata Santri Lengkap</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">1. Data Pribadi</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4"><small class="text-muted">Nama Lengkap</small><div class="fw-bold" id="d-nama"></div></div>
                        <div class="col-md-4"><small class="text-muted">NIK</small><div class="fw-bold" id="d-nik"></div></div>
                        <div class="col-md-4"><small class="text-muted">No. KK</small><div class="fw-bold" id="d-kk"></div></div>
                        <div class="col-md-4"><small class="text-muted">Tempat, Tgl Lahir</small><div class="fw-bold" id="d-ttl"></div></div>
                        <div class="col-md-4"><small class="text-muted">Jenis Kelamin</small><div class="fw-bold" id="d-jk"></div></div>
                        <div class="col-md-4"><small class="text-muted">Anak ke / Sdr</small><div class="fw-bold" id="d-anak"></div></div>
                        <div class="col-12"><small class="text-muted">Alamat Domisili</small><div class="fw-bold" id="d-alamat"></div></div>
                    </div>

                    <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">2. Data Orang Tua</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6"><small class="text-muted">Nama Ayah</small><div class="fw-bold" id="d-ayah"></div></div>
                        <div class="col-md-6"><small class="text-muted">No. HP Ayah</small><div class="fw-bold" id="d-hpayah"></div></div>
                        <div class="col-md-6"><small class="text-muted">Nama Ibu</small><div class="fw-bold" id="d-ibu"></div></div>
                        <div class="col-md-6"><small class="text-muted">No. HP Ibu</small><div class="fw-bold" id="d-hpibu"></div></div>
                        <div class="col-12"><small class="text-muted">Pekerjaan</small><div class="fw-bold" id="d-job"></div></div>
                    </div>

                    <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">3. Data Pondok</h6>
                    <div class="row g-3">
                        <div class="col-md-4"><small class="text-muted">Tanggal Masuk</small><div class="fw-bold" id="d-masuk"></div></div>
                        <div class="col-md-4"><small class="text-muted">Musyrif</small><div class="fw-bold" id="d-musyrif"></div></div>
                        <div class="col-md-4"><small class="text-muted">Status</small><div class="fw-bold" id="d-status"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // =========================================================
        // PENTING: GANTI URL DI BAWAH INI DENGAN URL DEPLOY ANDA
        // =========================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyDsY8m5T4xUmbLBPbEJn304gky3hb-uDmeovN__ja1SA9lFubdvsqb0YIEKdtDbUTk/exec"; 

        // Variabel Global Data Santri
        let globalSantriData = [];

        document.addEventListener("DOMContentLoaded", () => { loadData(); });

        // A. NAVIGASI
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('#sidebar .nav-link').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('active');
        }

        // B. LOAD DATA
        function loadData() {
            fetch(SCRIPT_URL + "?action=read")
                .then(res => res.json())
                .then(data => {
                    renderSantri(data.santri);
                    renderPegawai(data.pegawai);
                    renderJadwal(data.jadwal);
                    renderModul(data.modul);
                })
                .catch(err => {
                    console.error(err);
                    if(SCRIPT_URL.includes("URL_APPS")) alert("Harap ganti URL Script di index.html!");
                });
        }

        // C. RENDER SANTRI (TABEL RINGKAS)
        function renderSantri(rows) {
            globalSantriData = rows;
            let html = '';
            rows.forEach((row, index) => {
                if(!row[0]) return;
                html += `<tr>
                    <td>
                        <div class="fw-bold text-dark">${row[0]}</div>
                        <div class="small text-muted"><i class="fas fa-id-card me-1"></i>${row[5] || '-'}</div>
                    </td>
                    <td>${row[2] || '-'}</td>
                    <td>${row[4] || '-'}</td>
                    <td><span class="badge bg-success bg-opacity-10 text-success rounded-pill">${row[17] || 'Aktif'}</span></td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="showDetailSantri(${index})">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                    </td>
                </tr>`;
            });
            document.getElementById('bodySantri').innerHTML = html;
        }

        // D. RENDER LAINNYA
        function renderPegawai(r) {
            let h=''; r.forEach(x=>{if(x[0])h+=`<tr><td><div class="fw-bold">${x[0]}</div></td><td><span class="badge bg-secondary bg-opacity-10 text-secondary">${x[3]}</span></td><td>${x[4]}</td><td>${x[2]}</td></tr>`});
            document.getElementById('bodyPegawai').innerHTML=h;
        }
        function renderJadwal(r) {
            let h=''; r.forEach(x=>{if(x[1])h+=`<tr><td><span class="fw-bold text-primary">${x[1]}</span></td><td>${x[2]}</td><td class="fw-bold">${x[7]}</td><td>${x[8]}</td></tr>`});
            document.getElementById('bodyJadwal').innerHTML=h;
        }
        function renderModul(r) {
            let h=''; r.forEach(x=>{if(x[0])h+=`<div class="col-md-4"><div class="card h-100 p-4 text-center border"><i class="fas fa-file-pdf fa-3x text-danger mb-3"></i><h6 class="fw-bold">${x[0]}</h6><p class="small text-muted">${x[2]||''}</p><a href="${x[1]}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill mt-auto">Download</a></div></div>`});
            document.getElementById('containerModul').innerHTML=h;
        }

        // E. SHOW DETAIL SANTRI (POP-UP)
        function showDetailSantri(index) {
            const data = globalSantriData[index];
            const modal = new bootstrap.Modal(document.getElementById('modalDetailSantri'));
            
            // Mapping Index Array sesuai Database
            document.getElementById('d-nama').innerText = data[0];
            document.getElementById('d-ttl').innerText = (data[7]||'') + ", " + formatDate(data[1]);
            document.getElementById('d-alamat').innerText = data[2];
            document.getElementById('d-musyrif').innerText = data[4];
            document.getElementById('d-nik').innerText = data[5];
            document.getElementById('d-kk').innerText = data[6];
            document.getElementById('d-jk').innerText = data[8];
            document.getElementById('d-ayah').innerText = data[9];
            document.getElementById('d-ibu').innerText = data[10];
            document.getElementById('d-job').innerText = data[11];
            document.getElementById('d-hpayah').innerText = data[12];
            document.getElementById('d-hpibu').innerText = data[13];
            document.getElementById('d-masuk').innerText = formatDate(data[14]);
            document.getElementById('d-anak').innerText = `Anak ke ${data[15]} dari ${data[16]} bersaudara`;
            
            const st = document.getElementById('d-status');
            st.innerText = data[17];
            st.className = "fw-bold badge " + (data[17]==='Aktif'?'bg-success':'bg-warning');

            modal.show();
        }

        // F. OPEN MODAL FORM INPUT
        const formModal = new bootstrap.Modal(document.getElementById('modalForm'));
        function openModal(type) {
            document.getElementById('modalTitle').innerText = "Tambah " + type;
            document.getElementById('kategoriInput').value = type;
            const container = document.getElementById('formContainer');

            if (type === 'Santri') {
                container.innerHTML = `
                    <div class="alert alert-info py-2 small mb-3"><i class="fas fa-info-circle me-2"></i>Lengkapi 18 data santri.</div>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">Nama Lengkap</label><input type="text" class="form-control" name="nama" required></div>
                        <div class="col-md-6"><label class="form-label">Jenis Kelamin</label><select class="form-select" name="jk"><option>Laki-Laki</option><option>Perempuan</option></select></div>
                        <div class="col-md-6"><label class="form-label">Tempat Lahir</label><input type="text" class="form-control" name="tempat_lahir"></div>
                        <div class="col-md-6"><label class="form-label">Tanggal Lahir</label><input type="date" class="form-control" name="tgl_lahir"></div>
                        <div class="col-md-6"><label class="form-label">NIK</label><input type="number" class="form-control" name="nik"></div>
                        <div class="col-md-6"><label class="form-label">No. KK</label><input type="number" class="form-control" name="kk"></div>
                        <div class="col-12"><label class="form-label">Alamat</label><textarea class="form-control" name="alamat" rows="2"></textarea></div>
                        <div class="col-md-6"><label class="form-label">Anak Ke-</label><input type="number" class="form-control" name="anak_ke"></div>
                        <div class="col-md-6"><label class="form-label">Jlh Saudara</label><input type="number" class="form-control" name="jlh_saudara"></div>
                        
                        <h6 class="text-primary border-bottom pb-1 mt-3">Orang Tua & Pondok</h6>
                        <div class="col-md-6"><label class="form-label">Nama Ayah</label><input type="text" class="form-control" name="ayah"></div>
                        <div class="col-md-6"><label class="form-label">Nama Ibu</label><input type="text" class="form-control" name="ibu"></div>
                        <div class="col-md-6"><label class="form-label">HP Ayah</label><input type="text" class="form-control" name="hp_ayah"></div>
                        <div class="col-md-6"><label class="form-label">HP Ibu</label><input type="text" class="form-control" name="hp_ibu"></div>
                        <div class="col-12"><label class="form-label">Pekerjaan</label><input type="text" class="form-control" name="job"></div>
                        <div class="col-md-4"><label class="form-label">Tgl Masuk</label><input type="date" class="form-control" name="masuk"></div>
                        <div class="col-md-4"><label class="form-label">Musyrif</label><input type="text" class="form-control" name="musyrif"></div>
                        <div class="col-md-4"><label class="form-label">Status</label><select class="form-select" name="status"><option>Aktif</option><option>Yatim</option><option>Umum</option></select></div>
                    </div>`;
            } else {
                let l1, l2, l3, l4;
                if(type==='Pegawai'){l1="Nama";l2="Jabatan";l3="No HP";l4="Alamat";}
                else if(type==='Jadwal'){l1="Hari";l2="Waktu";l3="Materi";l4="Guru";}
                else{l1="Modul";l2="Link";l3="Ket";l4="-";}
                
                container.innerHTML = `<div class="mb-3"><label class="fw-bold">${l1}</label><input type="text" class="form-control" name="input1" required></div><div class="mb-3"><label class="fw-bold">${l2}</label><input type="text" class="form-control" name="input2"></div><div class="mb-3"><label class="fw-bold">${l3}</label><input type="text" class="form-control" name="input3"></div>${l4!=='-'?`<div class="mb-3"><label class="fw-bold">${l4}</label><input type="text" class="form-control" name="input4"></div>`:''}`;
            }
            formModal.show();
        }

        // G. SUBMIT DATA
        document.getElementById('mainForm').addEventListener('submit', e => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            const txt = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...'; btn.disabled = true;

            fetch(SCRIPT_URL, { method: 'POST', body: new FormData(e.target) })
                .then(res => { alert('Sukses!'); formModal.hide(); loadData(); })
                .catch(err => alert('Error: ' + err))
                .finally(() => { btn.innerHTML = txt; btn.disabled = false; });
        });

        // H. HELPER FORMAT TANGGAL
        function formatDate(d) {
            if(!d) return '-';
            const date = new Date(d);
            return isNaN(date) ? d : date.toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'numeric'});
        }
    </script>
</body>
</html>
