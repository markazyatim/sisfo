<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Markaz Qurani</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary-color: #008767; --secondary-color: #f1c40f; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Header Style */
        .navbar { background-color: var(--primary-color) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-link { color: rgba(255,255,255,0.8) !important; font-weight: 600; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { color: white !important; border-bottom: 3px solid var(--secondary-color); }

        /* Card & Section */
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-top: 20px; }
        .section-title { background: #e9ecef; padding: 8px 15px; font-weight: bold; color: var(--primary-color); border-left: 5px solid var(--primary-color); margin-top: 15px; border-radius: 4px; }
        
        /* Loading Overlay */
        #loading { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;
        }

        /* Table Style */
        .table thead { background-color: #343a40; color: white; }
        .btn-group .btn { margin: 0 2px; }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
    <span class="mt-2 fw-bold text-success">Memproses Data...</span>
</div>

<nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
        <a class="navbar-brand text-white fw-bold" href="#"><i class="fas fa-mosque me-2"></i>MARKAZ QURANI</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto nav-pills">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-santri">SANTRI</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-pegawai">PEGAWAI</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-jadwal">JADWAL</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="tab-santri">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="fw-bold text-success"><i class="fas fa-user-graduate me-2"></i>Data Santri</h4>
                    <button class="btn btn-success" onclick="openModal('Santri')"><i class="fa fa-plus"></i> Tambah Santri</button>
                </div>
                <button class="btn btn-outline-success w-100 mb-3" onclick="loadData('Santri')"><i class="fas fa-sync-alt me-2"></i>Tampilkan / Refresh Data</button>
                <div id="out-Santri"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-pegawai">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="fw-bold text-success"><i class="fas fa-user-tie me-2"></i>Data Pegawai</h4>
                    <button class="btn btn-success" onclick="openModal('Pegawai')"><i class="fa fa-plus"></i> Tambah Pegawai</button>
                </div>
                <button class="btn btn-outline-success w-100 mb-3" onclick="loadData('Pegawai')"><i class="fas fa-sync-alt me-2"></i>Tampilkan / Refresh Data</button>
                <div id="out-Pegawai"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-jadwal">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="fw-bold text-success"><i class="fas fa-calendar-alt me-2"></i>Jadwal Pelajaran</h4>
                    <button class="btn btn-success" onclick="openModal('Jadwal')"><i class="fa fa-plus"></i> Tambah Pelajaran</button>
                </div>
                <div class="btn-group w-100 mb-3">
                    <button class="btn btn-primary" onclick="loadData('Jadwal', 'Ganjil')">Semester Ganjil</button>
                    <button class="btn btn-info text-white" onclick="loadData('Jadwal', 'Genap')">Semester Genap</button>
                </div>
                <div id="out-Jadwal"></div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="mainModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="mainForm">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalTitle">Form Data</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-success px-4">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- MASUKKAN KODE JAVASCRIPT ANDA DI SINI ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwy1f9x5BSjlW9dCYad2qyv3IEkLAhyTTyXcsPIGAUIMfCVPnPYtwT_QfBQ95FxukDV/exec";
    let currentSheet = "";

    function toggleLoading(show) {
        const loader = document.getElementById('loading');
        if (loader) loader.style.display = show ? 'flex' : 'none';
    }

    function loadData(type, filter = null) {
        toggleLoading(true);
        const container = document.getElementById('out-' + type);
        container.innerHTML = `<div class="text-center p-4"><div class="spinner-border text-success"></div><p>Sedang mengambil data ${type}...</p></div>`;

        fetch(`${SCRIPT_URL}?targetSheet=${type}`)
        .then(r => r.json())
        .then(res => {
            let filteredRows = res.rows;
            if (type === 'Jadwal' && filter) {
                filteredRows = res.rows.filter(r => r[10] === filter);
            }

            if (filteredRows.length === 0) {
                container.innerHTML = `<div class="alert alert-warning mt-3">Data ${type} tidak ditemukan atau masih kosong.</div>`;
                toggleLoading(false);
                return;
            }

            let html = `<div class="table-responsive"><table class="table table-bordered table-hover align-middle bg-white shadow-sm small">`;
            html += `<thead class="table-dark text-nowrap"><tr>`;
            res.header.forEach(h => html += `<th>${h}</th>`);
            html += `<th class="text-center">AKSI</th></tr></thead><tbody>`;
            
            filteredRows.forEach((row) => {
                let actualIndex = res.rows.indexOf(row) + 2; 
                html += `<tr>`;
                row.forEach(cell => html += `<td>${cell || '-'}</td>`);
                html += `<td class="text-center text-nowrap">
                            <button class="btn btn-sm btn-warning text-white" onclick='handleEdit("${type}", ${JSON.stringify(row)}, ${actualIndex})'><i class="fa fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRow('${type}', ${actualIndex})"><i class="fa fa-trash"></i></button>
                        </td></tr>`;
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
            toggleLoading(false);
        })
        .catch(err => {
            container.innerHTML = `<div class="alert alert-danger">Kesalahan: ${err.message}</div>`;
            toggleLoading(false);
        });
    }

    function openModal(type, rowData = null, rowIndex = "") {
        currentSheet = type;
        document.getElementById('modalTitle').innerText = (rowData ? "EDIT DATA " : "TAMBAH DATA ") + type.toUpperCase();
        
        let body = `<input type="hidden" name="targetSheet" value="${type}"><input type="hidden" name="rowIndex" value="${rowIndex}">`;

        if (type === 'Santri') {
            body += `<div class="section-title">A. BIODATA SANTRI</div>
                <div class="row g-2 mt-1">
                    <div class="col-md-6"><label class="small fw-bold">Nama Lengkap</label><input type="text" name="nama" class="form-control" required value="${rowData?.[1]||''}"></div>
                    <div class="col-md-3"><label class="small fw-bold">Tempat Lahir</label><input type="text" name="tmp_lahir" class="form-control" value="${rowData?.[8]||''}"></div>
                    <div class="col-md-3"><label class="small fw-bold">Tgl Lahir</label><input type="date" name="tgl_lahir" class="form-control" value="${rowData?.[2]||''}"></div>
                    <div class="col-md-4"><label class="small fw-bold">Kelamin</label><select name="gender" class="form-select"><option ${rowData?.[9]=='Laki-laki'?'selected':''}>Laki-laki</option><option ${rowData?.[9]=='Perempuan'?'selected':''}>Perempuan</option></select></div>
                    <div class="col-md-4"><label class="small fw-bold">NIK</label><input type="number" name="nik" class="form-control" value="${rowData?.[6]||''}"></div>
                    <div class="col-md-4"><label class="small fw-bold">No KK</label><input type="number" name="kk" class="form-control" value="${rowData?.[7]||''}"></div>
                    <div class="col-12"><label class="small fw-bold">Alamat</label><textarea name="alamat" class="form-control" rows="2">${rowData?.[3]||''}</textarea></div>
                    <div class="col-md-4"><label class="small fw-bold">Tgl Masuk</label><input type="date" name="masuk" class="form-control" value="${rowData?.[15]||''}"></div>
                    <div class="col-md-4"><label class="small fw-bold">Musyrif</label><input type="text" name="musyrif" class="form-control" value="${rowData?.[5]||''}"></div>
                    <div class="col-md-4"><label class="small fw-bold">Status</label><select name="status" class="form-select">
                        <option ${rowData?.[18]=='Umum'?'selected':''}>Umum</option><option ${rowData?.[18]=='Yatim'?'selected':''}>Yatim</option><option ${rowData?.[18]=='Piatu'?'selected':''}>Piatu</option><option ${rowData?.[18]=='Duafa'?'selected':''}>Duafa</option>
                    </select></div>
                </div>
                <div class="section-title mt-3">B. DATA ORANG TUA</div>
                <div class="row g-2 mt-1">
                    <div class="col-md-6"><label class="small fw-bold">Nama Ayah</label><input type="text" name="ayah" class="form-control" value="${rowData?.[10]||''}"></div>
                    <div class="col-md-6"><label class="small fw-bold">Nama Ibu</label><input type="text" name="ibu" class="form-control" value="${rowData?.[11]||''}"></div>
                    <div class="col-md-4"><label class="small fw-bold">Pekerjaan</label><input type="text" name="job" class="form-control" value="${rowData?.[12]||''}"></div>
                    <div class="col-md-4"><label class="small fw-bold">HP Ayah</label><input type="number" name="hp_ayah" class="form-control" value="${rowData?.[13]||''}"></div>
                    <div class="col-md-4"><label class="small fw-bold">HP Ibu</label><input type="number" name="hp_ibu" class="form-control" value="${rowData?.[14]||''}"></div>
                </div>`;
        } else if (type === 'Pegawai') {
            body += `<div class="row g-3">
                <div class="col-12"><label class="small fw-bold">Nama Pegawai</label><input type="text" name="nama" class="form-control" required value="${rowData?.[1]||''}"></div>
                <div class="col-md-6"><label class="small fw-bold">Tgl Lahir</label><input type="date" name="tgl_lahir" class="form-control" value="${rowData?.[2]||''}"></div>
                <div class="col-md-6"><label class="small fw-bold">No HP</label><input type="number" name="hp" class="form-control" value="${rowData?.[5]||''}"></div>
                <div class="col-12"><label class="small fw-bold">Jabatan</label><input type="text" name="jabatan" class="form-control" value="${rowData?.[4]||''}"></div>
                <div class="col-12"><label class="small fw-bold">Alamat</label><textarea name="alamat" class="form-control" rows="2">${rowData?.[3]||''}</textarea></div>
            </div>`;
        } else if (type === 'Jadwal') {
            body += `<div class="row g-2">
                <div class="col-md-6"><label class="small fw-bold">Bulan ke-</label><input type="number" name="bulan" class="form-control" value="${rowData?.[1]||''}"></div>
                <div class="col-md-4"><label class="small fw-bold">Hari</label><select name="hari" class="form-select">
                    ${['Senin','Selasa','Rabu','Kamis','Jumat','Sabtu','Minggu'].map(h => `<option ${rowData?.[2]==h?'selected':''}>${h}</option>`).join('')}
                </select></div>
                <div class="col-md-4"><label class="small fw-bold">Waktu</label><input type="text" name="waktu" class="form-control" placeholder="08:00 - 09:00" value="${rowData?.[3]||''}"></div>
                <div class="col-md-4"><label class="small fw-bold">SKS</label><input type="number" name="sks" class="form-control" value="${rowData?.[4]||''}"></div>
                <div class="col-md-6"><label class="small fw-bold">Ruang</label><input type="text" name="ruang" class="form-control" required value="${rowData?.[8]||''}"></div>
                <div class="col-md-6"><label class="small fw-bold">Kelompok</label><input type="text" name="kelompok" class="form-control" value="${rowData?.[9]||''}"></div>
                <div class="col-md-4"><label class="small fw-bold">Klaster</label><input type="text" name="klaster" class="form-control" value="${rowData?.[5]||''}"></div>
                <div class="col-md-4"><label class="small fw-bold">Materi</label><input type="text" name="materi" class="form-control" value="${rowData?.[6]||''}"></div>
                <div class="col-md-4"><label class="small fw-bold">Guru</label><input type="text" name="guru" class="form-control" value="${rowData?.[7]||''}"></div>
            </div>`;
        }

        document.getElementById('modalBody').innerHTML = body;
        new bootstrap.Modal(document.getElementById('mainModal')).show();
    }

    document.getElementById('mainForm').onsubmit = function(e) {
        e.preventDefault();
        toggleLoading(true);
        fetch(SCRIPT_URL, { method: 'POST', body: new URLSearchParams(new FormData(this))})
        .then(r => r.text()).then(res => {
            alert(res);
            location.reload();
        }).catch(err => { alert("Error: " + err); toggleLoading(false); });
    };

    function handleEdit(type, data, index) { openModal(type, data, index); }

    function deleteRow(type, index) {
        if (!confirm("Hapus data ini secara permanen?")) return;
        toggleLoading(true);
        fetch(`${SCRIPT_URL}?action=delete&targetSheet=${type}&rowIndex=${index}`, {method: 'POST'})
        .then(r => r.text()).then(res => { alert(res); location.reload(); })
        .catch(err => { alert("Error: " + err); toggleLoading(false); });
    }
</script>
</body>
</html>
